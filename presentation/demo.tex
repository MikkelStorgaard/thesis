\documentclass[10pt, compress]{beamer}
\usetheme[progressbar=frametitle]{metropolis}

\usetheme[progressbar=frametitle]{metropolis}
\usepackage{appendixnumberbeamer}

\usepackage{booktabs}
\usepackage[scale=2]{ccicons}

\usepackage{pgfplots}
\usepgfplotslibrary{dateplot}

\usepackage{xspace}
\newcommand{\themename}{\textbf{\textsc{metropolis}}\xspace}
\usepackage[langlinenos]{minted}
\usepackage{listings}
\definecolor{green(ryb)}{rgb}{0.4, 0.69, 0.2}
\usepgfplotslibrary{dateplot}

\usemintedstyle{trac}


\setbeamercolor{framesubtitle}{fg=mDarkTeal}
\addtobeamertemplate{frametitle}{}{%
  \ifx\insertframesubtitle\@empty\else%
  \usebeamerfont{framesubtitle}%
  \usebeamercolor[fg]{framesubtitle}%
  \insertframesubtitle%
  \fi%
}

\title{FShark}
\titlegraphic{\hfill
  \includegraphics[height=.3\textheight]{fsharklogo.png}}
\subtitle{Effortless GPU Programming in F\#}
\author{Mikkel Storgaard Knudsen}
\institute{Master's Thesis presentation, University of Copenhagen}

\begin{document}

\maketitle

\begin{frame}[fragile]
\frametitle{What's the deal?}
\pause
\begin{itemize}
\item<+-> The future demands more efficient computing
\item<+-> not achievable by common sequential programming 
\end{itemize}
\pause 

% CUDA and OpenCL exists, but is a nuisance to write, and to use in mainstream languages

% we want a way to both develop and use efficient GPU computational kernels
% within mainstream language contexts.

\end{frame}

\begin{frame}[fragile]
\frametitle{Bird's eye view - A C\# Code Generator}
  
\begin{columns}[T] % align columns
\begin{column}{.48\textwidth}
  {\scriptsize
  \begin{align*}
    A &=& \begin{bmatrix}
      1 & 2 & 3 & 4 & 5 & 6 & 7 \\
      1 & 2 & 3 & 4 & 5 & 6 & 7 \\
      1 & 2 & 3 & 4 & 5 & 6 & 7 \\
      1 & 2 & 3 & 4 & 5 & 6 & 7 \\
      1 & 2 & 3 & 4 & 5 & 6 & 7 \\
      1 & 2 & 3 & 4 & 5 & 6 & 7
        \end{bmatrix} \\
    B &=& \begin{bmatrix}
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6 \\
      1 & 2 & 3 & 4 & 5 & 6
        \end{bmatrix} \\
    AB &=&
           \begin{bmatrix}
28 & 56 & 84 & 112 & 140 & 168 \\
28 & 56 & 84 & 112 & 140 & 168 \\
28 & 56 & 84 & 112 & 140 & 168 \\
28 & 56 & 84 & 112 & 140 & 168 \\
28 & 56 & 84 & 112 & 140 & 168
           \end{bmatrix}
  \end{align*}
  }%
\end{column}%
\hfill%
\pause
\begin{column}{.48\textwidth}
\begin{minted}[fontsize=\tiny, breaklines]{csharp}
using System;
using Matrix;
namespace Example
{
  internal class Program
  {
    public static void Main(string[] args)
    {
      var n = 5;
      var m = 7;
      var p = 6;
      var matrix = new Matrix.Matrix(args);

      var A = 
        matrix.replicateRows(n,m);
      var B = 
        matrix.replicateRows(m,p);
      var AB = 
        matrix.multiply(A,B);
    }
  }
}
\end{minted}
\end{column}%
\end{columns}
\end{frame}


\begin{frame}[plain,c]
\frametitle{Bird's eye view - A C\# Code Generator}
\begin{center}
  \Huge A Futhark extension
\end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Bird's eye view - A C\# Code Generator}
    \begin{figure}
      \begin{overprint}
        \onslide<1>\includegraphics{./images/futhark_diagram_before.pdf}
        \onslide<2>\includegraphics{./images/futhark_diagram_after.pdf}
      \end{overprint}
    \end{figure}

  %%% show diagram of futhark compilation pipeline
  %%%% for each part, elaborate and show example
\end{frame}

\begin{frame}[plain,c]
  \frametitle{Bird's eye view - The FShark Language}
  \begin{center}
    \Huge A language for GPU kernel programming
  \end{center}
\end{frame}

\begin{frame}[fragile, plain]
  \frametitle{Bird's eye view - The FShark Language}
\begin{columns}[T] % align columns
\begin{column}{.48\textwidth}
Prelude functions:\\
\begin{minted}[fontsize=\tiny, breaklines]{fsharp}
Replicate : int -> 't -> 't []

Iota : int -> int []

Transpose : 't [][] -> 't [][]

Map : (a -> b) -> a [] -> b []

Foldr : (a -> b -> b) -> b -> a [] -> b

Map2 : (a -> b -> c) -> a [] -> b [] -> c []
\end{minted}
\end{column}%
\hfill%
\pause
\begin{column}{.48\textwidth}
\texttt{matrix.fs}:
\begin{minted}[fontsize=\tiny, breaklines, linenos=true]{fsharp}
open FSharkPrelude
module Matrix
\end{minted}
\pause
\begin{minted}[fontsize=\tiny, breaklines, linenos=true, firstnumber=last]{fsharp}
type replicateRows : int -> int -> int [][] 
type multiply : int [][] 
                -> int [][] 
                -> int [][]
\end{minted}
\pause
\begin{minted}[fontsize=\tiny, breaklines, linenos=true, firstnumber=last]{fsharp}
let replicateRows n m = Replicate n (Iota m)
\end{minted}
\pause
\begin{minted}[fontsize=\tiny, breaklines, linenos=true, firstnumber=last]{fsharp}
let multiply A B =
  let BT = Transpose B
\end{minted}
\pause
\begin{minted}[fontsize=\tiny, breaklines, linenos=true, firstnumber=last]{fsharp}
  let Sum = Foldr (+) 0
\end{minted}
\pause
\begin{minted}[fontsize=\tiny, breaklines, linenos=true, firstnumber=last]{fsharp}
  in Map (fun row ->
       Map (fun col -> 
         Sum <| Map2 (*) row col
       ) BT
     ) A
\end{minted}
\end{column}%
\end{columns}
\end{frame}

\begin{frame}[plain,c]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
  \begin{center}
    \Huge An FShark compilation/invokation pipeline
  \end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns}[T] % align columns
\begin{column}{.38\textwidth}
\begin{minted}[fontsize=\tiny,linenos,breaklines, linenos=true]{fsharp}
module FSharkExample
open FShark.Main

let main argv =
  let wrapper = 
    new FSharkWrapper(
      libName="MatrixExample",
      tmpRoot="./",
      preludePath= "./FSharkPrelude.dll",
      openCL=true,
      unsafe=true,
      debug=false
      )
\end{minted}
\end{column}
\pause
\hfill
\begin{column}{.60\textwidth}
  \begin{figure}
    \includegraphics[scale=0.7]{./images/pipeline/pipeline1}
  \end{figure}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns}[T] % align columns
\begin{column}{.38\textwidth}
  \begin{figure}
\begin{minted}[fontsize=\tiny,linenos,breaklines, linenos=true]{fsharp}
module FSharkExample
open FShark.Main

let main argv =
  let wrapper = 
    new FSharkWrapper(
      libName="MatrixExample",
      tmpRoot="./",
      preludePath= "./FSharkPrelude.dll",
      openCL=true,
      unsafe=true,
      debug=false
      )
  wrapper.AddSourceFile "matrix.fs"
  wrapper.CompileAndLoad
\end{minted}
  \end{figure}
\end{column}
\hfill
\begin{column}{.60\textwidth}
  \begin{figure}
    \begin{overprint}
      \only<1>{\includegraphics[scale=0.7]{./images/pipeline/pipeline2}}
      \only<2>{\includegraphics[scale=0.7]{./images/pipeline/pipeline3}}
      \only<3>{\includegraphics[scale=0.7]{./images/pipeline/pipeline4}}
    \end{overprint}
  \end{figure}
\end{column}
\end{columns}
\end{frame}
  %% fshark transpiler and wrapping framework
  %%% explain use case
  %%% show large diagram of components, and explain individual parts
  %%%% for each part, elaborate and show example
  
\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns}[t] % align columns
\begin{column}{.38\textwidth}
  \begin{figure}
\begin{minted}[fontsize=\tiny, breaklines, linenos=true]{fsharp}
let multiply A B =
  let BT = Transpose B
  let Sum = Foldr (+) 0
  in Map (fun row ->
       Map (fun col -> 
         Sum <| Map2 (*) row col
       ) BT
     ) A
\end{minted}
  \end{figure}
\end{column}
\hfill
\begin{column}{.60\textwidth}
  \begin{figure}
    \includegraphics[scale=0.7]{./images/pipeline/pipeline5}
  \end{figure}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns}[t] % align columns
\begin{column}{.38\textwidth}
  \begin{figure}
\includegraphics[scale=0.6]{./images/multiplyAST}
  \end{figure}
\end{column}
\hfill
\begin{column}{.60\textwidth}
  \begin{figure}
    \includegraphics[scale=0.7]{./images/pipeline/pipeline5}
  \end{figure}
\end{column}
\end{columns}
\end{frame}
\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns}[t] % align columns
\begin{column}{.38\textwidth}
    \begin{minted}[fontsize=\tiny, linenos=true]{sml}
let multiply (A : [][]i32) (B : [][]i32) : [][]i32 =
 let BT = transpose (B) in
 let Sum =
   let f = (\(x : i32) -> (\(y : i32) ->
             ((x + y)))) in
   let acc = 0i32 
   in (\(bs : []i32) -> foldr (f) (acc) (bs))
 in map ((\(row : []i32) -> 
      map ((\(col : []i32) -> 
        (Sum (map2 (
               (\(x : i32) -> (\(y : i32) -> 
                 ((x * y))
             )
        )
      ) (row) 
    (col))))) (BT))) (A)
    \end{minted}
\end{column}
\hfill
\begin{column}{.60\textwidth}
  \begin{figure}
    \includegraphics[scale=0.7]{./images/pipeline/pipeline6}
  \end{figure}
\end{column}
\end{columns}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
\begin{columns} % align columns
\begin{column}{.38\textwidth}
\begin{minted}[fontsize=\tiny,linenos,breaklines, linenos=true]{fsharp}
module FSharkExample
open FShark.Main

let main argv =
  let wrapper = 
    new FSharkWrapper(
      libName="MatrixExample",
      tmpRoot="./",
      preludePath= "./FSharkPrelude.dll",
      openCL=true,
      unsafe=true,
      debug=false
      )
  wrapper.AddSourceFile "matrix.fs"
  wrapper.CompileAndLoad
\end{minted}
\begin{minted}[fontsize=\tiny,linenos, linenos=true, firstnumber=last]{fsharp}
  let n = 5;
  let m = 7;
  let p = 6;

  let A =
    wrapper.InvokeFunction("replicateRows",n,m);
  let B = 
    wrapper.InvokeFunction("replicateRows",m,p);
  let AB = 
    wrapper.InvokeFunction("multiply",A,B);

  printfn "Multiplying A with B gives us %A" AB
  0
\end{minted}
\end{column}
\begin{column}{.60\textwidth}
  \begin{figure}
    \includegraphics[scale=0.7]{./images/pipeline/pipeline2}
  \end{figure}
\end{column}
\end{columns}
\end{frame}
\begin{frame}[fragile]
  \frametitle{Bird's eye view - The FShark Compiler/Wrapper}
  % Choosing what types FShark should support, and how to implement the support
  % for these types. in particular the whole ding about arrays.

  % interoperability between F# and generated C# libraries
\end{frame}
\begin{frame}[plain]
  \frametitle{Challenges}
\begin{center}
  \Huge Selected implementation- and design challenges for FShark
\end{center}
  % Choosing what types FShark should support, and how to implement the support
  % for these types. in particular the whole ding about arrays.

  % interoperability between F# and generated C# libraries
\end{frame}

\begin{frame}[plain]
\frametitle{Challenges - Arrays in FShark}
\begin{itemize}
\item<1-> FShark compiles to Futhark, and Futhark is a functional array programming
language.
\item<2-> FShark should behave as closely to Futhark as possible.
\item<3-> Translating .NET types from F\# to, but how should we translate arrays?
\end{itemize}
  % Choosing what types FShark should support, and how to implement the support
  % for these types. in particular the whole ding about arrays.

  % interoperability between F# and generated C# libraries
\end{frame}

\begin{frame}[plain]
\frametitle{Challenges - Arrays in FShark}
\begin{columns}
  \begin{column}{.48\textwidth}
    Jagged arrays:
    \begin{itemize}
    \item<1-> {\color{red}prut}
    \end{itemize}
  \end{column}
  \begin{column}{.48\textwidth}
    Multidimensional arrays:
    \begin{itemize}
    \item<1-> {\color{green(ryb)}skid}
    \end{itemize}
  \end{column}
\end{columns}
  % Choosing what types FShark should support, and how to implement the support
  % for these types. in particular the whole ding about arrays.

  % interoperability between F# and generated C# libraries
\end{frame}

\begin{frame}[plain]
\frametitle{Bird's eye view - A C\# Code Generator}
\begin{center}
  \Huge A Futhark extension
\end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Evaluation}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Evaluation - Testing and correctness}

  % Futhark Code Generator (does it work as a Futhark backend?)
  %% yes, based on unit tests and benchmark suite
  
  % FShark language (Can we write complex GPU benchmarks in FShark?)

  % FShark Compiler (unit tests)

\end{frame}


\begin{frame}[fragile]
  \frametitle{Evaluation - Performance}

  % Look at how C# OpenCL performs compared to C OpenCL
  %% Boxplot for time increase/decrease for all benchmarks

  %% plot that describes runtime increase/decrease in correlation with input size

  %%% discuss where major differences comes from

  % Look at how C# performs compared to C
  %% Very few samples;
  %% Major differences
  %% Why are these differences so large?

  % All in all quite succesful

\end{frame}

\begin{frame}[fragile]
  \frametitle{Evaluation - Usability and interoperability}

  % Live demo of writing a matrix multiplication kernel in FShark
  %% Compile using F#
  %% Use resulting C# library in a C# project
  
\end{frame}

\begin{frame}[fragile]
  \frametitle{Related work}
\end{frame}

\plain{Questions?}

\end{document}